# Apache License
# Version 2.0, January 2004
# http://www.apache.org/licenses/
#
# TERMS AND CONDITIONS FOR USE, REPRODUCTION, AND DISTRIBUTION
#
# 1. Definitions.
#
# "License" shall mean the terms and conditions for use, reproduction,
# and distribution as defined by Sections 1 through 9 of this document.
#
# "Licensor" shall mean the copyright owner or entity granting the License.
#
# "Legal Entity" shall mean the union of the acting entity and all
# other entities that control, are controlled by, or are under common
# control with that entity. For the purposes of this definition,
# "control" means (i) the power, direct or indirect, to cause the
# direction or management of such entity, whether by contract or
# otherwise, or (ii) ownership of fifty percent (50%) or more of the
# outstanding shares, or (iii) beneficial ownership of such entity.
#
# "You" (or "Your") shall mean an individual or Legal Entity
# exercising permissions granted by this License.
#
# "Source" form shall mean the preferred form for making modifications,
# including but not limited to software source code, documentation
# source, and configuration files.
#
# "Object" form shall mean any form resulting from mechanical
# transformation or translation of a Source form, including but
# not limited to compiled object code, generated documentation,
# and conversions to other media types.
#
# "Work" shall mean the work of authorship, whether in Source or
# Object form, made available under the License, as indicated by a
# copyright notice that is included in or attached to the work
# (which shall not include communications that are individually
# marked or otherwise designated in writing by the copyright owner
# as "Not a Contribution").
#
# "Derivative Works" shall mean any work, whether in Source or Object
# form, that is based upon (or derived from) the Work and for which the
# editorial revisions, annotations, elaborations, or other modifications
# represent, as a whole, an original work of authorship. For the purposes
# of this License, Derivative Works shall not include works that remain
# separable from, or merely link (or bind by name) to the interfaces of,
# the Work and derivative works thereof.
#
# "Contribution" shall mean any work of authorship, including
# the original version of the Work and any modifications or additions
# to that Work or Derivative Works thereof, that is intentionally
# submitted to Licensor for inclusion in the Work by the copyright owner
# or by an individual or Legal Entity authorized to submit on behalf of
# the copyright owner. For the purposes of this definition, "submitted"
# means any form of electronic, verbal, or written communication sent
# to the Licensor or its representatives, including but not limited to
# communication on electronic mailing lists, source code control
# systems, and issue tracking systems that are managed by, or on behalf
# of, the Licensor for the purpose of discussing and improving the Work,
# but excluding communication that is conspicuously marked or otherwise
# designated in writing by the copyright owner as "Not a Contribution."
#
# 2. Grant of Copyright License. Subject to the terms and conditions of
# this License, each Contributor hereby grants to You a perpetual,
# worldwide, non-exclusive, no-charge, royalty-free, irrevocable
# copyright license to use, reproduce, modify, display, perform,
# sublicense, and distribute the Work and such Derivative Works in
# Source or Object form.
#
# 3. Grant of Patent License. Subject to the terms and conditions of
# this License, each Contributor hereby grants to You a perpetual,
# worldwide, non-exclusive, no-charge, royalty-free, irrevocable
# (except as stated in this section) patent license to make, have made,
# use, offer to sell, sell, import, and otherwise transfer the Work,
# where such license applies only to those patent claims licensable
# by such Contributor that are necessarily infringed by their
# Contribution(s) alone or by combination of their Contribution(s)
# with the Work to which such Contribution(s) was submitted. If You
# institute patent litigation against any entity (including a
# cross-claim or counterclaim in a lawsuit) alleging that the Work
# or a Contribution incorporated within the Work constitutes direct
# or contributory patent infringement, then any patent licenses
# granted to You under this License for that Work shall terminate
# as of the date such litigation is filed.
#
# 4. Redistribution. You may reproduce and distribute copies of the
# Work or Derivative Works thereof in any medium, with or without
# modifications, and in Source or Object form, provided that You
# meet the following conditions:
#
# (a) You must give any other recipients of the Work or
# Derivative Works a copy of this License; and
#
# (b) You must cause any modified files to carry prominent notices
# stating that You changed the files; and
#
# (c) You must retain, in the Source form of any Derivative Works
# that You distribute, all copyright, patent, trademark, and
# attribution notices from the Source form of the Work,
# excluding those notices that do not pertain to any part of
# the Derivative Works; and
#
# (d) If the Work includes a "NOTICE" text file as part of its
# distribution, then any Derivative Works that You distribute must
# include a readable copy of the attribution notices contained
# within such NOTICE file, excluding those notices that do not
# pertain to any part of the Derivative Works, in at least one
# of the following places: within a NOTICE text file distributed
# as part of the Derivative Works; within the Source form or
# documentation, if provided along with the Derivative Works; or,
# within a display generated by the Derivative Works, if and
# wherever such third-party notices normally appear. The contents
# of the NOTICE file are for informational purposes only and
# do not modify the License. You may add Your own attribution
# notices within Derivative Works that You distribute, alongside
# or as an addendum to the NOTICE text from the Work, provided
# that such additional attribution notices cannot be construed
# as modifying the License.
#
# You may add Your own copyright notice to Your modifications and
# may provide additional or different license terms and conditions
# for use, reproduction, or distribution of Your modifications, or
# for any such Derivative Works as a whole, provided Your use,
# reproduction, and distribution of the Work otherwise complies with
# the conditions stated in this License.
#
# 5. Submission of Contributions. Unless You explicitly state otherwise,
# any Contribution intentionally submitted for inclusion in the Work
# by You to the Licensor shall be under the terms and conditions of
# this License, without any additional terms or conditions.
# Notwithstanding the above, nothing herein shall supersede or modify
# the terms of any separate license agreement you may have executed
# with Licensor regarding such Contributions.
#
# 6. Trademarks. This License does not grant permission to use the trade
# names, trademarks, service marks, or product names of the Licensor,
# except as required for reasonable and customary use in describing the
# origin of the Work and reproducing the content of the NOTICE file.
#
# 7. Disclaimer of Warranty. Unless required by applicable law or
# agreed to in writing, Licensor provides the Work (and each
# Contributor provides its Contributions) on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied, including, without limitation, any warranties or conditions
# of TITLE, NON-INFRINGEMENT, MERCHANTABILITY, or FITNESS FOR A
# PARTICULAR PURPOSE. You are solely responsible for determining the
# appropriateness of using or redistributing the Work and assume any
# risks associated with Your exercise of permissions under this License.
#
# 8. Limitation of Liability. In no event and under no legal theory,
# whether in tort (including negligence), contract, or otherwise,
# unless required by applicable law (such as deliberate and grossly
# negligent acts) or agreed to in writing, shall any Contributor be
# liable to You for damages, including any direct, indirect, special,
# incidental, or consequential damages of any character arising as a
# result of this License or out of the use or inability to use the
# Work (including but not limited to damages for loss of goodwill,
# work stoppage, computer failure or malfunction, or any and all
# other commercial damages or losses), even if such Contributor
# has been advised of the possibility of such damages.
#
# 9. Accepting Warranty or Support. While redistributing the Work or
# Derivative Works thereof, You may choose to offer, and charge a fee
# for, acceptance of support, warranty, indemnity, or other liability
# obligations and/or rights consistent with this License. However, in
# accepting such obligations, You may act only on Your own behalf and on
# Your sole responsibility, not on behalf of any other Contributor, and
# only if You agree to indemnify, defend, and hold each Contributor
# harmless for any liability incurred by, or claims asserted against,
# such Contributor by reason of your accepting any such warranty or support.
#
# END OF TERMS AND CONDITIONS
#
# APPENDIX: How to apply the Apache License to your work.
#
# To apply the Apache License to your work, attach the following
# boilerplate notice, with the fields enclosed by brackets "[]"
# replaced with your own identifying information. (Don't include
# the brackets!)  The text should be enclosed in the appropriate
# comment syntax for the file format. We also recommend that a
# file or class name and description of purpose be included on the
# same "printed page" as the copyright notice for easier
# identification within third-party archives.
#
# Copyright [yyyy] [name of copyright owner]
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

"""Data models for CSV Editor MCP Server."""

from __future__ import annotations

from datetime import datetime
from enum import Enum
from typing import TYPE_CHECKING, Any, Literal

from pydantic import BaseModel, Field, field_validator

# Type aliases for common data types
CellValue = str | int | float | bool | None
FilterValue = CellValue | list[CellValue]

if TYPE_CHECKING:
    import pandas as pd


class DataType(str, Enum):
    """Supported data types for columns."""

    INTEGER = "integer"
    FLOAT = "float"
    STRING = "string"
    DATETIME = "datetime"
    BOOLEAN = "boolean"
    MIXED = "mixed"


class OperationType(str, Enum):
    """Types of operations that can be performed."""

    LOAD = "load"
    FILTER = "filter"
    SORT = "sort"
    TRANSFORM = "transform"
    AGGREGATE = "aggregate"
    EXPORT = "export"
    ANALYZE = "analyze"
    UPDATE_COLUMN = "update_column"
    ADD_COLUMN = "add_column"
    REMOVE_COLUMN = "remove_column"
    RENAME = "rename"
    SELECT = "select"
    CHANGE_TYPE = "change_type"
    FILL_MISSING = "fill_missing"
    REMOVE_DUPLICATES = "remove_duplicates"
    GROUP_BY = "group_by"
    VALIDATE = "validate"
    PROFILE = "profile"
    QUALITY_CHECK = "quality_check"
    ANOMALY_DETECTION = "anomaly_detection"


class ComparisonOperator(str, Enum):
    """Comparison operators for filtering."""

    EQUALS = "="
    NOT_EQUALS = "!="
    GREATER_THAN = ">"
    LESS_THAN = "<"
    GREATER_THAN_OR_EQUALS = ">="
    LESS_THAN_OR_EQUALS = "<="
    CONTAINS = "contains"
    NOT_CONTAINS = "not_contains"
    STARTS_WITH = "starts_with"
    ENDS_WITH = "ends_with"
    IN = "in"
    NOT_IN = "not_in"
    IS_NULL = "is_null"
    IS_NOT_NULL = "is_not_null"


class LogicalOperator(str, Enum):
    """Logical operators for combining conditions."""

    AND = "AND"
    OR = "OR"
    NOT = "NOT"


class AggregateFunction(str, Enum):
    """Aggregate functions for data analysis."""

    SUM = "sum"
    MEAN = "mean"
    MEDIAN = "median"
    MIN = "min"
    MAX = "max"
    COUNT = "count"
    COUNT_DISTINCT = "count_distinct"
    STD = "std"
    VAR = "var"
    FIRST = "first"
    LAST = "last"


class ExportFormat(str, Enum):
    """Supported export formats."""

    CSV = "csv"
    TSV = "tsv"
    JSON = "json"
    EXCEL = "excel"
    PARQUET = "parquet"
    HTML = "html"
    MARKDOWN = "markdown"


class FilterCondition(BaseModel):
    """A single filter condition."""

    column: str = Field(..., description="Column name to filter on")
    operator: ComparisonOperator = Field(..., description="Comparison operator")
    value: FilterValue = Field(None, description="Value to compare against")

    @field_validator("value", mode="before")
    @classmethod
    def validate_value(cls, v: FilterValue, info: Any) -> FilterValue:
        """Validate value based on operator."""
        operator = info.data.get("operator") if hasattr(info, "data") else None
        if operator in [ComparisonOperator.IS_NULL, ComparisonOperator.IS_NOT_NULL]:
            return None
        if operator in [
            ComparisonOperator.IN,
            ComparisonOperator.NOT_IN,
        ] and not isinstance(v, list):
            return [v]
        return v


class SortSpec(BaseModel):
    """Specification for sorting data."""

    column: str = Field(..., description="Column to sort by")
    ascending: bool = Field(True, description="Sort in ascending order")


class ColumnSchema(BaseModel):
    """Schema definition for a column."""

    name: str = Field(..., description="Column name")
    dtype: DataType = Field(..., description="Data type")
    nullable: bool = Field(True, description="Whether column can contain null values")
    unique: bool = Field(False, description="Whether values must be unique")
    min_value: float | int | str | None = Field(None, description="Minimum value")
    max_value: float | int | str | None = Field(None, description="Maximum value")
    allowed_values: list[CellValue] | None = Field(None, description="List of allowed values")
    pattern: str | None = Field(None, description="Regex pattern for validation")


class DataSchema(BaseModel):
    """Complete schema for a dataset."""

    columns: list[ColumnSchema] = Field(..., description="Column definitions")
    row_count: int | None = Field(None, description="Expected number of rows")
    primary_key: list[str] | None = Field(None, description="Primary key columns")

    def validate_dataframe(self, df: pd.DataFrame) -> dict[str, Any]:
        """Validate a DataFrame against this schema."""
        errors = []
        warnings = []

        # Check columns
        expected_cols = {col.name for col in self.columns}
        actual_cols = set(df.columns)

        missing_cols = expected_cols - actual_cols
        extra_cols = actual_cols - expected_cols

        if missing_cols:
            errors.append(f"Missing columns: {missing_cols}")
        if extra_cols:
            warnings.append(f"Extra columns: {extra_cols}")

        # Validate each column
        for col_schema in self.columns:
            if col_schema.name not in df.columns:
                continue

            col_data = df[col_schema.name]

            # Check nullability
            if not col_schema.nullable and col_data.isnull().any():
                errors.append(f"Column {col_schema.name} contains null values")

            # Check uniqueness
            if col_schema.unique and col_data.duplicated().any():
                errors.append(f"Column {col_schema.name} contains duplicate values")

            # Check allowed values
            if col_schema.allowed_values:
                invalid = ~col_data.isin(col_schema.allowed_values)
                if invalid.any():
                    errors.append(f"Column {col_schema.name} contains invalid values")

        return {"valid": len(errors) == 0, "errors": errors, "warnings": warnings}


class DataQualityRule(BaseModel):
    """A data quality rule to check."""

    name: str = Field(..., description="Rule name")
    description: str = Field(..., description="Rule description")
    column: str | None = Field(None, description="Column to check (if applicable)")
    rule_type: Literal["completeness", "uniqueness", "validity", "consistency", "accuracy"] = Field(
        ..., description="Type of quality check"
    )
    expression: str | None = Field(None, description="Expression to evaluate")
    threshold: float | None = Field(None, description="Threshold for pass/fail")


class OperationResult(BaseModel):
    """Result of a data operation."""

    success: bool = Field(..., description="Whether operation succeeded")
    message: str = Field(..., description="Result message")
    session_id: str | None = Field(None, description="Session ID")
    rows_affected: int | None = Field(None, description="Number of rows affected")
    columns_affected: list[str] | None = Field(None, description="Columns affected")
    data: dict[str, Any] | None = Field(None, description="Additional result data")
    error: str | None = Field(None, description="Error message if failed")
    warnings: list[str] | None = Field(None, description="Warning messages")


class SessionInfo(BaseModel):
    """Information about a data session."""

    session_id: str = Field(..., description="Unique session identifier")
    created_at: datetime = Field(..., description="Session creation time")
    last_accessed: datetime = Field(..., description="Last access time")
    row_count: int = Field(..., description="Number of rows in dataset")
    column_count: int = Field(..., description="Number of columns")
    columns: list[str] = Field(..., description="Column names")
    memory_usage_mb: float = Field(..., description="Memory usage in MB")
    operations_count: int = Field(0, description="Number of operations performed")
    file_path: str | None = Field(None, description="Source file path")


class DataStatistics(BaseModel):
    """Statistical summary of data."""

    column: str = Field(..., description="Column name")
    dtype: str = Field(..., description="Data type")
    count: int = Field(..., description="Non-null count")
    null_count: int = Field(..., description="Null count")
    unique_count: int = Field(..., description="Unique value count")
    mean: float | None = Field(None, description="Mean (numeric only)")
    std: float | None = Field(None, description="Standard deviation (numeric only)")
    min: CellValue = Field(None, description="Minimum value")
    max: CellValue = Field(None, description="Maximum value")
    q25: float | None = Field(None, description="25th percentile (numeric only)")
    q50: float | None = Field(None, description="50th percentile (numeric only)")
    q75: float | None = Field(None, description="75th percentile (numeric only)")
    top_values: dict[str, int] | None = Field(None, description="Top 10 most frequent values")
